---
title: "Provincial Groundwater Observation Well Network (PGOWN)"
subtitle: "Snapshot Report : February 2020"
output: html_document
     
---
<!--
Copyright 2019 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

The Provincial Groundwater Observation Well Network Snapshot has taken place every year around February and July, since 2015. The PGOWN has been active since 1961 and is a cross-ministry long-term groundwater level monitoring commitment between the Ministry of Environment and Climate Change Strategy and the Ministry of Forests, Lands, Natural Resource Operations and Rural Development. All publicly available, active PGOWN well information from the PGOWN [Interactive Map](https://governmentofbc.maps.arcgis.com/apps/webappviewer/index.html?id=b53cb0bf3f6848e79d66ffd09b74f00d) is assessed on a region-by-region/area-by-area basis. For this snapshot, current conditions at the time of assessment are compared to specific, established network operating standards. This assessment is part of a long established continuous-improvement model for network operations.

```{r include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

```


```{r setup, include=FALSE}

## Load libraries
library(readr) #load data from BC Data Catalogue
library(readxl) #load xlsx files
library(dplyr) # data munging
library(envreportutils)
library(tidyr)
library(stringr)
library(lubridate)
library(gridExtra)
library(here) 
library(ggplot2)
library(bcmaps)
library(bcdata)
library(sf)
library(leaflet)
library(leafpop)
library(patchwork)



load("tmp/wellsum.RData")

wells_regions <- st_transform(wells_regions, crs = 4326) # convert to lat/long
wells_joined <- st_transform(wells_joined, crs = 4326) # convert to lat/long

reg_plot_list <- readRDS("reg_plot_list.rds")

```

### Provincial Snapshot 

```{r provincial plots, include = TRUE, echo= FALSE, fig.align="left", fig.height=3, fig.width = 6.4}
#define the location of tick marks along the date axis (Feb/Jul)
date.ticks <- unique(well.stats$report_date)
date.ticks <- sort(date.ticks)

p1 <- well.stats %>% group_by(report_date) %>% summarize(no.active = sum(no.active.wells)) %>%
  ggplot(aes(report_date, no.active)) +
    scale_x_date(breaks = date.ticks, date_labels = "%b-%y")+
    geom_bar(stat = "identity") +
    ylab("Number of Active Wells") +
    xlab("") +
    ggtitle("Number of Active Provincial Monitoring Wells")
p1
```

```{r provincial plots 2, include = TRUE, echo= FALSE, fig.align="left", fig.height=3, fig.width = 8, fig.cap="INSERT TITLE HERE"}
y.lim.max <- 50
p2 <- ggplot(well.stats, aes(report_date, mth.ave, fill = Region)) +
  geom_col(position = "dodge") +
  scale_x_date(breaks = date.ticks, date_labels = "%b-%y")+
  geom_hline(yintercept=7, linetype="dashed", color = "red") +
  theme(legend.position='none') +
  coord_cartesian(ylim = c(0, y.lim.max)) +
  ylab("No. of Months") +
  xlab("") +
  theme(legend.position="right") +
  ggtitle("Average Number of Months to Validation")
p2
```

text place holder 

```{r provincial plots 3, include = TRUE, echo= FALSE, fig.align="left", fig.height= 3, fig.width = 8, fig.cap="INSERT 2nd TITLE HERE"}
p3 <- ggplot(well.stats, aes(report_date, 100 - pc.gth.7, fill = Region)) +
  geom_col(position = "dodge") +
  scale_x_date(breaks = date.ticks, date_labels = "%b-%y")+
  ylab("%") +
  xlab("") +
  theme(legend.position="right") +
  ggtitle("Percent of Wells Meeting the 7 Month Target")

p3


```


The target of publishing publicly available water level data that has been validated within the past 7 months was implemented in February 2015. The South Coast Region and the South Area implemented a full-time, dedicated Groundwater Technician in January 2016.



## Regional Snapshots


```{r months over time plot ,  include = TRUE, echo= FALSE, fig.align="leftr" , caption = "Average Months Since Validated with mean and standard deviation" }

ggplot(well.stats, aes(report_date, mth.ave, color = Region, fill = Region, shape = Region)) +
  facet_wrap(~Region, scales = "free")+
  geom_pointrange(aes(ymin = mth.ave - mth.sd , ymax = mth.ave + mth.sd )) +
  geom_line() +
  ylab("No. of Months") +
  xlab("") +
  theme(legend.position = "none")

```


## Interactive Map 
Click on the maps below to explore the trends across the province.

# {.tabset .tabset-fade}

## Map 

```{r, echo = FALSE}

 library(leaflet)
 

# create labels 

 labs <- dplyr::select(wells_regions, Region)
 st_geometry(labs) <- NULL
 
 labs_wells <- dplyr::select(wells_joined, Location, inactive, OBSERVATION_WELL_NUMBER, Months_since_val )
  st_geometry(labs_wells) <- NULL
 
 lab1 <- lapply(seq(nrow(labs)), function(i) {
   paste0( '<b>', "Region: ", labs[i, "Region"],'</b>') 
 })
 
 lab2 <- lapply(seq(nrow(labs_wells)), function(i) {
   #ifelse(as.numeric(labs_wells[i, "Months_since_val"]) < 7, 
          paste0( '<b>', labs_wells[i, "Location"], " (#",
                  labs_wells[i, "OBSERVATION_WELL_NUMBER"], ")",'</b>'#, 
   #         paste0( '<b>', labs_wells[i, "Location"], " (#",
   #                labs_wells[i, "OBSERVATION_WELL_NUMBER"], ")", 
   #               labs_wells[i, "Months_since_val"], "(months since validation)", '</b>')
   )
 }) 
 

# create pop-ups
  
 popup_reg <- popupGraph(reg_plot_list[unique(well.stats$Region)], 
                          type = "svg", width = 400, height = 300)
  

 popup_well <- dplyr::select(wells_joined, Location, 
                             OBSERVATION_WELL_NUMBER,
                             Months_since_val
                             ) %>% 
  rename("Well Location" = Location,
         "Well Observation No." = OBSERVATION_WELL_NUMBER,
         "Months since Validation" = Months_since_val) %>%
   mutate(`Months since Validation` = ifelse(as.numeric(`Months since Validation`) < 7, "<7",
                                             `Months since Validation`))
  
st_geometry(popup_well) <- NULL 

wells_popup <- leafpop::popupTable(popup_well ,
                                   row.numbers = F, 
                                   feature.id = F)
  
  
  
 palette1 <- colorFactor(palette = 'viridis', wells_regions$Region, reverse = TRUE)
# palette2 <-  colorFactor(palette = "Blues", domain = wells_joined$map_colour)
 palette2 <-  colorFactor(palette = c("dark green","dark red"), levels = c("green", "red"))

 
 watermap <- leaflet(width = "900px", height = "600px", 
                     options = leafletOptions(minZoom = 5)) %>%  
   addProviderTiles(providers$Stamen.Terrain, group = "Terrain") %>%
   add_bc_home_button() %>%
   set_bc_view()
 
   watermap %>% 
   addPolygons(data = wells_regions, 
               stroke = T, weight = 1, color = "black", # Add border to polygons
               fillOpacity = 0.5, # Polygon fill
               fillColor = ~palette1(wells_regions$Region),
               label = lapply(lab1, htmltools::HTML),
               popup = popup_reg,
               popupOptions = popupOptions(
                 maxWidth = "100%", 
                 autoPan = TRUE,
                 keepInView = TRUE,
                 closeOnClick = TRUE,
                 autoPanPaddingTopLeft = c(120, 20),
                 autoPanPaddingBottomRight = c(150,20)),
               labelOptions = labelOptions(direction = "auto", textsize = "12px")) %>%
      addCircles(data = wells_joined, radius = 10, 
               #fillColor = ~palette2(wells_joined$map_colour),
               color = wells_joined$map_colour,
               opacity = 0.9,
               popup = wells_popup,
               label = lapply(lab2, htmltools::HTML),
               highlightOptions = highlightOptions( 
                 weight = 3,
                 color = "yellow",
                 bringToFront = T))
 
```


## Caveats 

*This assessment was completed February 10th, 2020 and is current as of this date.

### Method: 
All active PGOWN wells publicly available on the [PGOWN Interactive Map](https://governmentofbc.maps.arcgis.com/apps/webappviewer/index.html?id=b53cb0bf3f6848e79d66ffd09b74f00d) are assessed on a region-by-region basis. The water level data is downloaded for each well and the last month that the data is categorized as validated, is noted. For each region, the % of wells in that region with validated data greater than 7 months old is determined. For each region, the average age of data is determined based on the number of wells displayed on the interactive map at the time of the snapshot and the total age (in months) of the validated data.

*The number of active wells displayed on the interactive map may change from year to year as wells are added / removed from PGOWN (i.e. it is not static)

*This review checks the frequency of publicly available data validation, quality of systems operations (Aquarius Database / PGOWN Interactive Map) and communications, frequency of site visits, and overall efficiency of network protocols that have been implemented. This review and report can be used as one of several metrics for overall workload of PGOWN staff.

*Sites may show as ‘active’ on the map when they are inactive (no longer collecting data), new monitoring sites collecting data may not be displayed on the map at the time of the snapshot assessment.

*The focus of this ‘snapshot’ is on publicly available validated groundwater level data. The monitoring sites equipped with properly working satellite telemetry equipment should still be transmitting near real time unvalidated data.


